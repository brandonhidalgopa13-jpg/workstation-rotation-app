#!/bin/bash
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ SCRIPT DE BUILD PARA RELEASE - REWS v2.2.0
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Automatiza el proceso completo de testing, calidad y generaciรณn de APK

set -e  # Exit on any error

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ญ REWS - ROTATION AND WORKSTATION SYSTEM - BUILD PARA RELEASE"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Verificar que estamos en el directorio correcto
if [ ! -f "gradlew" ]; then
    echo "โ Error: No se encontrรณ gradlew"
    echo "   Asegรบrate de ejecutar este script desde la raรญz del proyecto"
    exit 1
fi

# Hacer gradlew ejecutable
chmod +x gradlew

echo "๐ Iniciando proceso de build completo..."
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐งน LIMPIEZA
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐งน Paso 1/6: Limpiando proyecto..."
./gradlew clean
echo "โ Limpieza completada"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐งช TESTS UNITARIOS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐งช Paso 2/6: Ejecutando tests unitarios..."
if ! ./gradlew testDebugUnitTest; then
    echo "โ Error en tests unitarios"
    echo "๐ Revisa los reportes en: app/build/reports/tests/testDebugUnitTest/index.html"
    exit 1
fi
echo "โ Tests unitarios completados"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ ANรLISIS DE CALIDAD
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ Paso 3/6: Ejecutando anรกlisis de calidad (Lint)..."
if ! ./gradlew lint; then
    echo "โ๏ธ  Advertencia: Se encontraron issues de lint"
    echo "๐ Revisa los reportes en: app/build/reports/lint/lint-results.html"
    read -p "๐ค ยฟContinuar con el build? (s/N): " continue
    if [[ ! $continue =~ ^[Ss]$ ]]; then
        echo "โ Build cancelado por el usuario"
        exit 1
    fi
fi
echo "โ Anรกlisis de calidad completado"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ COBERTURA DE CรDIGO
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ Paso 4/6: Generando reporte de cobertura..."
if ! ./gradlew jacocoTestReport; then
    echo "โ๏ธ  Advertencia: Error generando reporte de cobertura"
    echo "๐ Revisa los logs para mรกs detalles"
fi
echo "โ Reporte de cobertura generado"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ง BUILD DEBUG (VERIFICACIรN)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ง Paso 5/6: Verificando build debug..."
if ! ./gradlew assembleDebug; then
    echo "โ Error en build debug"
    exit 1
fi
echo "โ Build debug verificado"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ BUILD RELEASE
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ Paso 6/6: Generando APK de release..."

# Verificar si existe keystore.properties
if [ ! -f "keystore.properties" ]; then
    echo "โ๏ธ  Advertencia: No se encontrรณ keystore.properties"
    echo "   Se usarรก keystore de debug para firmar la APK"
    echo "   Para producciรณn, configura keystore.properties siguiendo keystore.properties.example"
    echo ""
fi

if ! ./gradlew assembleRelease; then
    echo "โ Error en build release"
    echo "๐ก Posibles causas:"
    echo "   - Problemas con keystore.properties"
    echo "   - Errores de ProGuard"
    echo "   - Dependencias faltantes"
    exit 1
fi

echo "โ APK de release generada exitosamente"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ RESUMEN FINAL
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ BUILD COMPLETADO EXITOSAMENTE"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ฑ APK de release generada en:"
echo "   app/build/outputs/apk/release/app-release.apk"
echo ""
echo "๐ Reportes disponibles:"
echo "   ๐งช Tests: app/build/reports/tests/testDebugUnitTest/index.html"
echo "   ๐ Lint: app/build/reports/lint/lint-results.html"
echo "   ๐ Cobertura: app/build/reports/jacoco/jacocoTestReport/html/index.html"
echo ""
echo "๐ Informaciรณn de la APK:"

# Mostrar informaciรณn de la APK si existe
APK_PATH="app/build/outputs/apk/release/app-release.apk"
if [ -f "$APK_PATH" ]; then
    APK_SIZE=$(stat -f%z "$APK_PATH" 2>/dev/null || stat -c%s "$APK_PATH" 2>/dev/null || echo "N/A")
    echo "   ๐ฆ Tamaรฑo: $APK_SIZE bytes"
    echo "   ๐ Generada: $(date)"
    echo "   ๐ท๏ธ  Versiรณn: 2.2.0"
    echo "   ๐ฏ Target SDK: 34"
    echo "   ๐ฑ Min SDK: 24"
fi

echo ""
echo "๐ ยกLa APK estรก lista para distribuciรณn!"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"